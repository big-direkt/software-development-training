name: Generate last-commit and contributors badges
on:
  push:
    branches: ["main"]
    paths-ignore:
      - 'assets/badges/**'

jobs:
  build-badges:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get last commit date (YYYY-MM-DD)
        id: commit
        run: |
          # last commit in ISO format YYYY-MM-DD
          echo "date=$(git show -s --format=%cI HEAD | cut -d'T' -f1)" >> $GITHUB_OUTPUT

      - name: Render SVG badges into assets/badges (last-commit + contributors)
        run: |
          mkdir -p assets/badges
          DATE=${{ steps.commit.outputs.date }}

          CONTRIBUTORS=$(git shortlog -sne HEAD | wc -l | tr -d ' ')

          cat > assets/badges/last-commit.svg <<SVG
          <svg xmlns="http://www.w3.org/2000/svg" width="220" height="20" role="img" aria-label="last commit">
            <rect width="110" height="20" fill="#555"/>
            <rect x="110" width="110" height="20" fill="#B8860B"/>

            <!-- GitHub icon (Octocat) -->
            <g transform="translate(6,3) scale(0.85)" fill="#fff" aria-hidden="true">
              <svg x="0" y="0" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 .297C5.37.297 0 5.667 0 12.297c0 5.302 3.438 9.8 8.205 11.387.6.111.82-.26.82-.577 0-.285-.01-1.04-.015-2.04-3.338.726-4.042-1.61-4.042-1.61-.546-1.387-1.333-1.757-1.333-1.757-1.09-.745.083-.73.083-.73 1.205.084 1.84 1.234 1.84 1.234 1.07 1.835 2.807 1.305 3.492.998.108-.775.418-1.305.762-1.605-2.665-.305-5.466-1.332-5.466-5.932 0-1.31.468-2.381 1.235-3.221-.123-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23a11.52 11.52 0 013.003-.404c1.018.005 2.045.138 3.003.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.652.241 2.873.118 3.176.77.84 1.232 1.911 1.232 3.221 0 4.61-2.803 5.624-5.475 5.921.43.37.815 1.096.815 2.21 0 1.596-.015 2.884-.015 3.276 0 .319.216.694.825.576C20.565 22.092 24 17.592 24 12.297 24 5.67 18.63.297 12 .297z"/>
              </svg>
            </g>

            <g fill="#fff" font-family="Verdana,DejaVu Sans,Helvetica,sans-serif" font-size="11">
              <text x="30" y="14">last commit</text>
            </g>

            <g fill="#fff" font-family="Verdana,DejaVu Sans,Helvetica,sans-serif" font-size="11">
              <text x="125" y="14">${DATE}</text>
            </g>
          </svg>
          SVG

          cat > assets/badges/contributors.svg <<SVG
          <svg xmlns="http://www.w3.org/2000/svg" width="260" height="20" role="img" aria-label="contributors">
            <rect width="130" height="20" fill="#555"/>
            <rect x="130" width="130" height="20" fill="#556B2F"/>

            <!-- GitHub icon (Octocat) -->
            <g transform="translate(8,3) scale(0.85)" fill="#fff" aria-hidden="true">
              <svg x="0" y="0" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 .297C5.37.297 0 5.667 0 12.297c0 5.302 3.438 9.8 8.205 11.387.6.111.82-.26.82-.577 0-.285-.01-1.04-.015-2.04-3.338.726-4.042-1.61-4.042-1.61-.546-1.387-1.333-1.757-1.333-1.757-1.09-.745.083-.73.083-.73 1.205.084 1.84 1.234 1.84 1.234 1.07 1.835 2.807 1.305 3.492.998.108-.775.418-1.305.762-1.605-2.665-.305-5.466-1.332-5.466-5.932 0-1.31.468-2.381 1.235-3.221-.123-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23a11.52 11.52 0 013.003-.404c1.018.005 2.045.138 3.003.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.652.241 2.873.118 3.176.77.84 1.232 1.911 1.232 3.221 0 4.61-2.803 5.624-5.475 5.921.43.37.815 1.096.815 2.21 0 1.596-.015 2.884-.015 3.276 0 .319.216.694.825.576C20.565 22.092 24 17.592 24 12.297 24 5.67 18.63.297 12 .297z"/>
              </svg>
            </g>

            <g fill="#fff" font-family="Verdana,DejaVu Sans,Helvetica,sans-serif" font-size="11">
              <text x="40" y="14">contributors</text>
            </g>

            <g fill="#fff" font-family="Verdana,DejaVu Sans,Helvetica,sans-serif" font-size="11">
              <text x="170" y="14">${CONTRIBUTORS}</text>
            </g>
          </svg>
          SVG

      - name: Commit and push badge(s) if changed
        run: |
          if ! git diff --quiet -- assets/badges; then
            DATE=${{ steps.commit.outputs.date }}
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add assets/badges
            git commit -m "Documented: Update last-commit and contributors badges (${DATE})." || true
            git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main
          else
            echo "No changes to assets/badges."
          fi
